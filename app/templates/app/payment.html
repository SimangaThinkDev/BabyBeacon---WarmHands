{% extends 'app/layout.html' %}
{% load static %}

{% block title %}Make Payment{% endblock %}

{% block head_content %}
<style>
    .payment-response {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        display: none;
    }

    .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left: 4px solid #FFA500;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Custom select styling to match your inputs */
    select {
        width: 100%;
        padding: 15px 35px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        background-color: white;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 15px;
        color: #333;
    }

    select:focus {
        outline: none;
        border-color: var(--highlight-color);
        box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.1);
    }

    /* Ensure icons align with select and inputs */
    .form-group i {
        left: 15px;
    }

    /* Match label style if needed */
    .form-label {
        font-size: 0.9rem;
        color: #aaa;
        margin-bottom: 5px;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="payment-header">
        <h2 class="dashboard-title">Complete Your Payment</h2>
    </div>

    <div class="payment-form card">
        <h4>Enter Payment Details</h4>

        <!-- AMOUNT FIELD -->
        <div class="form-group">
            <i class="fas fa-money-bill-wave"></i>
            <input 
                type="number" 
                step="0.01" 
                id="amount" 
                placeholder="Amount (e.g. 150.00)" 
                value="{{ default_amount }}" 
                required
            >
        </div>

        <!-- CURRENCY DROPDOWN (ZAR DEFAULT) -->
        <div class="form-group">
            <i class="fas fa-coins"></i>
            <select id="currency" required>
                <option value="ZAR" selected>South African Rand (ZAR)</option>
                <option value="UGX">Ugandan Shilling (UGX)</option>
                <option value="GHS">Ghanaian Cedi (GHS)</option>
                <option value="XOF">West African CFA (XOF)</option>
                <option value="USD">US Dollar (USD)</option>
            </select>
        </div>

        <!-- MTN PHONE NUMBER -->
        <div class="form-group">
            <i class="fas fa-phone"></i>
            <input 
                type="tel" 
                id="phone-number" 
                placeholder="Enter MTN Number (e.g. 07XXXXXXXX)" 
                required
            >
        </div>

        <button id="pay-btn" class="payment-button">Initiate Payment</button>

        <div id="loading" style="display: none; text-align: center; margin-top: 15px;">
            <span class="spinner"></span> Processing Request...
        </div>

        <div id="payment-response" class="payment-response"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('pay-btn').addEventListener('click', async function() {
        const amount = document.getElementById('amount').value.trim();
        const currency = document.getElementById('currency').value;
        const phoneNumber = document.getElementById('phone-number').value.trim();
        const userId = "{{ user_id|default:'null'|safe }}";

        // Validate fields
        if (!amount || parseFloat(amount) <= 0) {
            showAlert('Please enter a valid amount', 'error');
            return;
        }

        if (!phoneNumber || phoneNumber.length < 9) {
            showAlert('Please enter a valid MTN number', 'error');
            return;
        }

        // Disable button + show loader
        this.disabled = true;
        document.getElementById('loading').style.display = 'block';

        try {
            const response = await fetch('{% url "app:momo_request_to_pay" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    amount: amount,
                    currency: currency,
                    phone_number: phoneNumber,
                    user_id: userId
                })
            });

            const result = await response.json();

            if (result.status === 'pending') {
                showAlert(`‚úÖ Request sent! Reference: ${result.reference_id}`, 'success');
                pollPaymentStatus(result.reference_id);
            } else {
                showAlert(result.error || 'Payment failed', 'error');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'error');
        } finally {
            this.disabled = false;
            document.getElementById('loading').style.display = 'none';
        }
    });

    function showAlert(message, type) {
        const responseDiv = document.getElementById('payment-response');
        responseDiv.textContent = message;
        responseDiv.className = `payment-response ${type}`;
        responseDiv.style.display = 'block';
    }

    async function pollPaymentStatus(referenceId) {
        const maxAttempts = 12;
        let attempts = 0;

        const interval = setInterval(async () => {
            attempts++;
            try {
                const response = await fetch(`/api/momo/check-status/${referenceId}/`);
                const statusData = await response.json();

                if (statusData.status === 'SUCCESSFUL') {
                    clearInterval(interval);
                    showAlert('üéâ Payment Successful! Thank you.', 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard/'; // Redirect on success
                    }, 3000);
                } else if (['FAILED', 'EXPIRED'].includes(statusData.status)) {
                    clearInterval(interval);
                    showAlert('‚ùå Payment Failed. Please try again.', 'error');
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    showAlert('‚è≥ Still waiting... Check your MoMo app.', 'error');
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, 5000);
    }
</script>
{% endblock %}